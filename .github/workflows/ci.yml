name: CI Tests, Code Quality & Security with SonarQube

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-quality-security:
    runs-on: ubuntu-latest
    name: ğŸ§ª Tests, Quality & Security Pipeline with SonarQube

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov safety bandit

    - name: ğŸ§ª Run tests with coverage
      run: |
        echo "ğŸ§ª Running tests with coverage..."
        pytest --cov=. --cov-report=xml --cov-report=term --cov-report=html -v

    - name: ğŸ” Package Vulnerability Scan (Detailed)
      id: safety-check
      run: |
        echo "ğŸ›¡ï¸ Scanning for vulnerable Python packages..."
        echo "================================================"
        
        safety check --json --output safety-report.json || true
        safety check --output safety-report.txt || true
        
        if [ -f "safety-report.json" ]; then
          vuln_count=$(jq length safety-report.json 2>/dev/null || echo "0")
          echo "SAFETY_VULNS=$vuln_count" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ“Š PACKAGE VULNERABILITY SCAN RESULTS:"
          echo "======================================"
          echo "ğŸš¨ Total Vulnerable Packages: $vuln_count"
          echo ""
          
          if [ "$vuln_count" -gt 0 ]; then
            echo "SAFETY_FAILED=true" >> $GITHUB_ENV
            echo "ğŸš¨ DETAILED VULNERABLE PACKAGES:"
            echo "--------------------------------"
            
            jq -r '.[] | "
        ğŸ”´ VULNERABILITY FOUND:
           ğŸ“¦ Package: \(.package) (version \(.installed_version))
           ğŸš¨ Issue: \(.vulnerability)
           ğŸ†” CVE ID: \(.id)
           ğŸ“Š Severity: HIGH
           ğŸ”— More info: \(.more_info_url // "N/A")
           ğŸ’¡ Description: \(.advisory // "Security vulnerability detected")
           ----------------------------------------"' safety-report.json 2>/dev/null || echo "Vulnerabilities found in packages"
            
            echo ""
            echo "âŒ PACKAGE SECURITY CHECK: FAILED"
          else
            echo "âœ… No vulnerable packages detected"
            echo "SAFETY_FAILED=false" >> $GITHUB_ENV
          fi
        else
          echo "âœ… No vulnerable packages detected"
          echo "SAFETY_FAILED=false" >> $GITHUB_ENV
        fi

    - name: ğŸ›¡ï¸ Code Security Vulnerability Scan (Detailed)
      id: bandit-scan
      run: |
        echo "ğŸ” Scanning code for security vulnerabilities..."
        echo "==============================================="
        
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt -o bandit-report.txt || true
        bandit -r . || true
        
        if [ -f "bandit-report.json" ]; then
          high_issues=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
          medium_issues=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
          low_issues=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-report.json 2>/dev/null || echo "0")
          
          echo "BANDIT_HIGH=$high_issues" >> $GITHUB_ENV
          echo "BANDIT_MEDIUM=$medium_issues" >> $GITHUB_ENV
          echo "BANDIT_LOW=$low_issues" >> $GITHUB_ENV
          
          echo ""
          echo "ğŸ“Š CODE SECURITY VULNERABILITY SCAN RESULTS:"
          echo "==========================================="
          echo "ğŸ”´ High Severity Issues: $high_issues"
          echo "ğŸŸ¡ Medium Severity Issues: $medium_issues"
          echo "ğŸ”µ Low Severity Issues: $low_issues"
          echo ""
          
          if [ "$high_issues" -gt 0 ]; then
            echo "BANDIT_FAILED=true" >> $GITHUB_ENV
            echo "ğŸš¨ HIGH SEVERITY VULNERABILITIES FOUND:"
            echo "--------------------------------------"
            
            jq -r '.results[] | select(.issue_severity == "HIGH") | "
        ğŸ”´ HIGH SEVERITY VULNERABILITY:
           ğŸ“ File: \(.filename)
           ğŸ“ Line: \(.line_number)
           ğŸ” Test: \(.test_name)
           ğŸš¨ Issue: \(.issue_text)
           ğŸ’¡ Description: \(.issue_text)
           âš ï¸  Confidence: \(.issue_confidence)
           ğŸ”§ Recommendation: Review and fix this security issue
           ----------------------------------------"' bandit-report.json 2>/dev/null
          fi
          
          if [ "$medium_issues" -gt 0 ]; then
            echo ""
            echo "ğŸŸ¡ MEDIUM SEVERITY VULNERABILITIES FOUND:"
            echo "----------------------------------------"
            
            jq -r '.results[] | select(.issue_severity == "MEDIUM") | "
        ğŸŸ¡ MEDIUM SEVERITY VULNERABILITY:
           ğŸ“ File: \(.filename)
           ğŸ“ Line: \(.line_number)
           ğŸ” Test: \(.test_name)
           ğŸš¨ Issue: \(.issue_text)
           ğŸ’¡ Description: \(.issue_text)
           âš ï¸  Confidence: \(.issue_confidence)
           ğŸ”§ Recommendation: Consider fixing this security issue
           ----------------------------------------"' bandit-report.json 2>/dev/null
          fi
          
          if [ "$high_issues" -gt 0 ]; then
            echo ""
            echo "âŒ CODE SECURITY CHECK: FAILED (High severity issues found)"
          else
            echo "âœ… No high severity vulnerabilities detected"
            echo "BANDIT_FAILED=false" >> $GITHUB_ENV
          fi
        else
          echo "âœ… No code security vulnerabilities detected"
          echo "BANDIT_FAILED=false" >> $GITHUB_ENV
        fi

    - name: ğŸ” SonarQube Scanner
      uses: sonarsource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-report.txt
          safety-report.json
          safety-report.txt
          coverage.xml

    - name: ğŸ“Š Security Vulnerability Summary
      if: always()
      run: |
        echo "ğŸ›¡ï¸ COMPREHENSIVE SECURITY SCAN SUMMARY"
        echo "====================================="
        echo ""
        
        safety_vulns=${SAFETY_VULNS:-0}
        echo "ğŸ“¦ PACKAGE VULNERABILITIES: $safety_vulns"
        
        bandit_high=${BANDIT_HIGH:-0}
        bandit_medium=${BANDIT_MEDIUM:-0}
        bandit_low=${BANDIT_LOW:-0}
        echo "ğŸ” CODE SECURITY ISSUES:"
        echo "   ğŸ”´ High Severity: $bandit_high"
        echo "   ğŸŸ¡ Medium Severity: $bandit_medium"
        echo "   ğŸ”µ Low Severity: $bandit_low"
        echo ""
        
        total_critical=$((safety_vulns + bandit_high))
        if [ "$total_critical" -gt 0 ]; then
          echo "ğŸš¨ OVERALL STATUS: CRITICAL ISSUES FOUND ($total_critical)"
          echo "âŒ BUILD FAILED: Security vulnerabilities must be addressed"
          echo ""
          echo "ğŸ“‹ NEXT STEPS:"
          echo "1. Review detailed vulnerability information above"
          echo "2. Check SonarQube dashboard for additional insights"
          echo "3. Fix high severity vulnerabilities before deployment"
          echo "4. Update vulnerable packages to secure versions"
          exit 1
        elif [ "$bandit_medium" -gt 0 ]; then
          echo "âš ï¸  OVERALL STATUS: MEDIUM ISSUES FOUND ($bandit_medium)"
          echo "âœ… BUILD PASSED: But consider addressing medium severity issues"
        else
          echo "âœ… OVERALL STATUS: NO SECURITY ISSUES FOUND"
          echo "ğŸ‰ BUILD PASSED: All security checks successful"
        fi
        
        echo ""
        echo "ğŸ”— VIEW DETAILED ANALYSIS:"
        echo "   â€¢ SonarQube Dashboard: ${{ secrets.SONAR_HOST_URL }}/dashboard?id=Python_App"
        echo "   â€¢ Security Reports: Available in build artifacts"
